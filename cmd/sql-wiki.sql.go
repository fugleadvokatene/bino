// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: sql-wiki.sql

package main

import (
	"context"

	"github.com/jackc/pgx/v5/pgtype"
)

const addWikiPage = `-- name: AddWikiPage :one
WITH p AS (
    INSERT INTO wiki_page (title, created, creator)
    VALUES ($1, NOW(), $2)
    RETURNING id
),
r AS (
    INSERT INTO wiki_revision (page_id, content, edited, editor)
    SELECT id, '{}', NOW(), $2
    FROM p
    RETURNING id AS revision_id, page_id
)
SELECT page_id, revision_id
FROM r
`

type AddWikiPageParams struct {
	Title   string
	Creator int32
}

type AddWikiPageRow struct {
	PageID     int32
	RevisionID int32
}

func (q *Queries) AddWikiPage(ctx context.Context, arg AddWikiPageParams) (AddWikiPageRow, error) {
	row := q.db.QueryRow(ctx, addWikiPage, arg.Title, arg.Creator)
	var i AddWikiPageRow
	err := row.Scan(&i.PageID, &i.RevisionID)
	return i, err
}

const associateFileWithWikiPage = `-- name: AssociateFileWithWikiPage :exec
INSERT INTO file_wiki (file_id, wiki_id)
VALUES ($1, $2)
`

type AssociateFileWithWikiPageParams struct {
	FileID int32
	WikiID int32
}

func (q *Queries) AssociateFileWithWikiPage(ctx context.Context, arg AssociateFileWithWikiPageParams) error {
	_, err := q.db.Exec(ctx, associateFileWithWikiPage, arg.FileID, arg.WikiID)
	return err
}

const getLastWikiRevision = `-- name: GetLastWikiRevision :one
SELECT p.id, p.sort_order, p.title, p.created, p.creator, r.id, r.page_id, r.content, r.edited, r.editor
FROM wiki_page p
JOIN wiki_revision r ON r.page_id = p.id
WHERE p.id = $1
ORDER BY r.edited DESC
LIMIT 1
`

type GetLastWikiRevisionRow struct {
	ID        int32
	SortOrder pgtype.Int4
	Title     string
	Created   pgtype.Timestamptz
	Creator   int32
	ID_2      int32
	PageID    int32
	Content   []byte
	Edited    pgtype.Timestamptz
	Editor    int32
}

func (q *Queries) GetLastWikiRevision(ctx context.Context, id int32) (GetLastWikiRevisionRow, error) {
	row := q.db.QueryRow(ctx, getLastWikiRevision, id)
	var i GetLastWikiRevisionRow
	err := row.Scan(
		&i.ID,
		&i.SortOrder,
		&i.Title,
		&i.Created,
		&i.Creator,
		&i.ID_2,
		&i.PageID,
		&i.Content,
		&i.Edited,
		&i.Editor,
	)
	return i, err
}

const getWikiMainPage = `-- name: GetWikiMainPage :one
SELECT
    wp.id, wp.sort_order, wp.title, wp.created, wp.creator,
    wr.id AS revision_id,
    wr.content AS content
FROM wiki_revision AS wr
JOIN (
  SELECT id, sort_order, title, created, creator
  FROM wiki_page
  ORDER BY sort_order
  LIMIT 1
) AS wp ON wr.page_id = wp.id
ORDER BY wr.edited DESC
LIMIT 1
`

type GetWikiMainPageRow struct {
	ID         int32
	SortOrder  pgtype.Int4
	Title      string
	Created    pgtype.Timestamptz
	Creator    int32
	RevisionID int32
	Content    []byte
}

func (q *Queries) GetWikiMainPage(ctx context.Context) (GetWikiMainPageRow, error) {
	row := q.db.QueryRow(ctx, getWikiMainPage)
	var i GetWikiMainPageRow
	err := row.Scan(
		&i.ID,
		&i.SortOrder,
		&i.Title,
		&i.Created,
		&i.Creator,
		&i.RevisionID,
		&i.Content,
	)
	return i, err
}

const getWikiPages = `-- name: GetWikiPages :many
SELECT id, sort_order, title, created, creator FROM wiki_page
ORDER BY sort_order ASC, id ASC
`

func (q *Queries) GetWikiPages(ctx context.Context) ([]WikiPage, error) {
	rows, err := q.db.Query(ctx, getWikiPages)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []WikiPage
	for rows.Next() {
		var i WikiPage
		if err := rows.Scan(
			&i.ID,
			&i.SortOrder,
			&i.Title,
			&i.Created,
			&i.Creator,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const saveWikiPage = `-- name: SaveWikiPage :one
INSERT INTO wiki_revision (page_id, content, edited, editor)
VALUES ($1, $2, NOW(), $3)
RETURNING id
`

type SaveWikiPageParams struct {
	PageID  int32
	Content []byte
	Editor  int32
}

func (q *Queries) SaveWikiPage(ctx context.Context, arg SaveWikiPageParams) (int32, error) {
	row := q.db.QueryRow(ctx, saveWikiPage, arg.PageID, arg.Content, arg.Editor)
	var id int32
	err := row.Scan(&id)
	return id, err
}

const setWikiPageTitle = `-- name: SetWikiPageTitle :exec
UPDATE wiki_page
SET title = $1
WHERE id = $2
`

type SetWikiPageTitleParams struct {
	Title string
	ID    int32
}

func (q *Queries) SetWikiPageTitle(ctx context.Context, arg SetWikiPageTitleParams) error {
	_, err := q.db.Exec(ctx, setWikiPageTitle, arg.Title, arg.ID)
	return err
}
